# Payment System Setup Guide

## Overview
Your AJ STUDIOZ application now has a complete Indian payment system with two providers:

1. **Cashfree** - Primary Indian payment provider (UPI, Cards, Net Banking, Wallets)
2. **DodoPayments** - Fallback Indian payment provider

**Note**: Polar (international payments) has been removed to focus exclusively on Indian market.

## Environment Variables Setup

### Required Payment Variables
Add these to your `.env.local` file:

```bash
# Cashfree (Primary Indian Payments)  
CASHFREE_APP_ID=your_cashfree_app_id_here
CASHFREE_SECRET_KEY=your_cashfree_secret_key_here
CASHFREE_WEBHOOK_SECRET=your_cashfree_webhook_secret_here

# DodoPayments (Fallback Indian Payments)
DODO_PAYMENTS_API_KEY=your_dodo_payments_api_key_here
DODO_PAYMENTS_WEBHOOK_SECRET=your_dodo_payments_webhook_secret_here

# Product Configuration (Custom Identifiers)
NEXT_PUBLIC_PREMIUM_TIER=aj_studioz_pro_dodo
NEXT_PUBLIC_PREMIUM_SLUG=pro-plan-dodo
NEXT_PUBLIC_CASHFREE_PRODUCT_ID=aj_studioz_pro_1299
```

## Important Notes About Environment Variables

### Custom Product Identifiers
Some environment variables are **custom identifiers** you create yourself:

- `NEXT_PUBLIC_CASHFREE_PRODUCT_ID` - Your custom product ID (e.g., "aj_studioz_pro_1299")
- `NEXT_PUBLIC_PREMIUM_TIER` - Your custom DodoPayments product ID (e.g., "aj_studioz_pro_dodo")  
- `NEXT_PUBLIC_PREMIUM_SLUG` - Your custom DodoPayments product slug (e.g., "pro-plan-dodo")

### Generated by Payment Providers
These are generated when you set up webhooks:
- `CASHFREE_WEBHOOK_SECRET` - Generated when creating webhook in Cashfree dashboard
- `DODO_PAYMENTS_WEBHOOK_SECRET` - Generated when creating webhook in DodoPayments dashboard

## How to Get API Keys

### 1. Polar Setup
1. Go to [Polar](https://polar.sh) and create an account
2. Create a product for "AJ STUDIOZ Pro" at $15/month
3. Get your Access Token from API settings
4. Set up webhook endpoint: `https://yourdomain.com/api/auth/polar/webhook`
5. Copy the webhook secret

### 2. Cashfree Setup (Recommended for India)
1. Go to [Cashfree](https://cashfree.com) and create a merchant account  
2. Complete KYC verification process
3. Get your App ID and Secret Key from dashboard → API → Keys
4. Set up webhook endpoint: `https://yourdomain.com/api/webhooks/cashfree`
   - Go to Developers → Webhooks → Add Webhook
   - Select events: `PAYMENT_SUCCESS_WEBHOOK`, `PAYMENT_FAILED_WEBHOOK`, `PAYMENT_USER_DROPPED_WEBHOOK`
   - The webhook secret will be generated automatically
5. **IMPORTANT**: The `CASHFREE_WEBHOOK_SECRET` is generated when you create the webhook
6. **IMPORTANT**: `NEXT_PUBLIC_CASHFREE_PRODUCT_ID` is your custom product identifier - set it as "aj_studioz_pro_1299"

### 3. DodoPayments Setup (Fallback)
1. Go to [DodoPayments](https://dodopayments.com) and create an account
2. Create a product for "AJ STUDIOZ Pro" at ₹1299 + GST
3. Get your API Key from Settings → API Keys
4. Set up webhook endpoint: `https://yourdomain.com/api/auth/dodopayments/webhook`
   - Go to Settings → Webhooks → Add Webhook
   - Select events: `payment.completed`, `payment.failed`, `subscription.created`
   - The webhook secret is provided when you create the webhook
5. **IMPORTANT**: `NEXT_PUBLIC_PREMIUM_TIER` and `NEXT_PUBLIC_PREMIUM_SLUG` are custom identifiers you create:
   - Set `NEXT_PUBLIC_PREMIUM_TIER=aj_studioz_pro_dodo` 
   - Set `NEXT_PUBLIC_PREMIUM_SLUG=pro-plan-dodo`

## Payment Flow

### For Indian Users:
1. **Pricing Page**: Shows both UPI payment and subscription options
2. **Primary Payment**: One-time payment via Cashfree (₹1299 + GST)
3. **Fallback Payment**: One-time payment via DodoPayments (₹1299 + GST)  
4. **Subscription**: Monthly billing via Polar ($15/month)

### For International Users:
1. **Pricing Page**: Shows subscription option only  
2. **Monthly Subscription**: Via Polar ($15/month)

## Features Included

✅ **Complete Payment Infrastructure**
- Dual payment provider support
- Automatic subscription management
- Real-time Pro status updates
- Payment history tracking

✅ **User Experience**  
- Instant Pro activation after payment
- Customer portal for subscription management
- Detailed invoicing with GST calculation
- Success/failure handling

✅ **Admin Features**
- Subscription status API endpoint
- Webhook processing for payment confirmations  
- Comprehensive user data with payment history
- Cache management for performance

## API Endpoints

- `GET /api/subscription/status` - Check user's subscription status
- `POST /api/cashfree/checkout` - Create Cashfree payment session
- `POST /api/webhooks/cashfree` - Handle Cashfree webhooks
- `POST /api/auth/polar/webhook` - Handle Polar webhooks  
- `POST /api/auth/dodopayments/webhook` - Handle DodoPayments webhooks
- `POST /api/webhooks/payments` - Additional webhook processing

## Testing

1. Set up test products in both Polar and DodoPayments
2. Use sandbox/test mode API keys
3. Test payment flows:
   - Indian UPI payment → Pro activation
   - International subscription → Pro activation  
   - Webhook processing → Status updates

## Local Development

For local testing, create a `.env.local` file with minimal required variables:

```bash
# Minimal configuration for local development
BETTER_AUTH_SECRET=development_secret_key
BETTER_AUTH_URL=http://localhost:3000
DATABASE_URL=your_database_url_here

# Payment Product IDs - use same values as in Vercel
NEXT_PUBLIC_STARTER_TIER=your_polar_product_id
NEXT_PUBLIC_STARTER_SLUG=your_polar_product_slug
NEXT_PUBLIC_PREMIUM_TIER=aj_studioz_pro_dodo
NEXT_PUBLIC_PREMIUM_SLUG=pro-plan-dodo
NEXT_PUBLIC_CASHFREE_PRODUCT_ID=aj_studioz_pro_1299
```

**Note**: The pricing page requires these `NEXT_PUBLIC_*` variables to function. If you see an error page about missing environment variables, either:
1. Add the variables to your `.env.local` file, or
2. Test the payment functionality on your deployed Vercel app instead

## Production Deployment

1. Update environment variables with production API keys in Vercel dashboard
2. Set webhook URLs to your production domain
3. Test payment flows in production
4. Monitor webhook processing and error logs

## Support

The system automatically handles:
- Payment processing and confirmations
- Pro status activation/deactivation  
- Subscription renewals and cancellations
- Invoice generation and GST calculation
- Customer portal access for subscription management

For issues, check the webhook logs and ensure all environment variables are correctly set.